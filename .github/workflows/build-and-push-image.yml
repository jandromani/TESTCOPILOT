name:  Ejecutar Pipeline de CI (Desde Contenedor)

# 1. Definici贸n de Triggers
on:
  # Permite la ejecuci贸n manual desde la UI de GitHub Actions
  workflow_dispatch: {}
  # Se dispara autom谩ticamente en cada push a la rama principal
  push:
    branches:
      - main
  # Tambi茅n se recomienda para Pull Requests
  pull_request:
    branches:
      - main

# 2. Definici贸n de Jobs
jobs:
  run-pipeline:
    name: Pipeline de Integraci贸n Continua
    
    #  CRTICO: El host donde se ejecutar谩 el contenedor.
    runs-on: ubuntu-latest
    
    # 3. Configuraci贸n del Contenedor Docker
    container:
      # La imagen Docker pre-construida desde GHCR
      image: ghcr.io/${{ github.repository }}:latest
      
      # 锔 Mejora: Autenticaci贸n de la imagen en GHCR
      # Se recomienda usar un 'token' o 'pat' en lugar de username/password 
      # en el bloque 'credentials' para descargar im谩genes privadas en jobs.
      credentials:
        # ${{ github.actor }} es el usuario que activ贸 la acci贸n
        username: ${{ github.actor }} 
        # ${{ secrets.GITHUB_TOKEN }} es el token temporal de la acci贸n
        password: ${{ secrets.GITHUB_TOKEN }}
        
    # 4. Inyecci贸n de Variables de Entorno
    env:
      # Inyecci贸n de la clave secreta
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }} 
      # Variables de configuraci贸n del LLM
      ENABLE_LLM: '1'
      OPENROUTER_API_URL: 'https://api.openrouter.ai/v1/chat/completions'

    # 5. Pasos de Ejecuci贸n
    steps:
      - name: 1. Checkout del C贸digo Fuente
        # Este paso descarga el c贸digo fuente y lo monta dentro del contenedor
        uses: actions/checkout@v4
      
      - name: 2. Ejecutar Diagn贸sticos de Entorno (Dentro del Contenedor)
        # Verifica que Node/NPM y el entorno sean correctos.
        run: node scripts/vscode-env-diagnostics.js

      - name: 3. Ejecutar Pipeline Principal (Dentro del Contenedor)
        # Ejecuta el script principal de la pipeline
        run: node scripts/run-pipeline.js tests/fixtures/example-spec.json
      
      - name: 4. Listar Directorio de Estado para Depuraci贸n
        # Muestra el contenido de 'state/' antes de subir los artifacts
        run: |
          echo "Contenido de 'state/' despu茅s de la ejecuci贸n:"
          ls -la state || true

      - name: 5. Subir Artifacts de Estado
        # Almacena los resultados de la pipeline para su descarga
        uses: actions/upload-artifact@v4
        with:
          name: worldminiapp-state-artifacts
          path: state/**
          retention-days: 7 # Opcional: define cu谩ntos d铆as se guarda
